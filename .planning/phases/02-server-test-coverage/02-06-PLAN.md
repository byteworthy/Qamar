---
phase: 02-server-test-coverage
plan: 06
type: tdd
wave: 1
depends_on: []
files_modified:
  - server/__tests__/toneClassifier.test.ts
autonomous: true

must_haves:
  truths:
    - "Tone classification correctly identifies thinkers vs feelers vs balanced modes"
    - "Emotional markers trigger feeler classification"
    - "Analytical markers trigger thinker classification"
  artifacts:
    - path: "server/__tests__/toneClassifier.test.ts"
      provides: "Comprehensive tone classifier tests"
      min_lines: 80
      exports: []
  key_links:
    - from: "server/__tests__/toneClassifier.test.ts"
      to: "server/toneClassifier.ts"
      via: "import classifyTone"
      pattern: "import.*classifyTone.*from.*toneClassifier"
---

<objective>
Add comprehensive unit tests for server/toneClassifier.ts covering tone classification logic (thinkers, feelers, balanced).

Purpose: Validate that tone detection correctly adapts AI responses to user's communication style - essential for therapeutic effectiveness.

Output: Complete test suite with edge case coverage.
</objective>

<execution_context>
@C:\Users\richa\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\richa\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-server-test-coverage/02-CONTEXT.md
@server/toneClassifier.ts
@server/__tests__/conversational-ai.test.ts
</context>

<feature>
  <name>Tone Classifier Test Suite</name>
  <files>
    - server/__tests__/toneClassifier.test.ts
    - server/toneClassifier.ts
  </files>
  <behavior>
**Test Coverage Areas:**

1. **Feeler Classification** - Emotional language detection
   - Input: "I feel so anxious and scared about everything"
   - Expected: mode="feelers", confidence >0.6
   - Markers: feel, anxious, scared trigger feeler mode
   - Multiple emotional markers increase confidence

2. **Thinker Classification** - Analytical language detection
   - Input: "I think the issue is that I'm overthinking this logically"
   - Expected: mode="thinkers", confidence >0.6
   - Markers: think, issue, logically, overthinking trigger thinker mode
   - Multiple analytical markers increase confidence

3. **Balanced Classification** - Mixed or neutral language
   - Input: "I need help with something"
   - Expected: mode="balanced", confidence moderate
   - No strong emotional or analytical markers
   - Balanced classification is default fallback

4. **High Confidence Detection**
   - Input with many emotional markers → feelers, confidence >0.8
   - Input with many analytical markers → thinkers, confidence >0.8
   - Confidence score scales with marker count

5. **Sentence Length Analysis** - Style-based scoring
   - Long sentences (>15 words avg) → +2 analytical score
   - Short sentences (<8 words avg) → +1 emotional score
   - Influences final classification alongside marker detection

6. **Abstract vs Concrete Language** - Content-based scoring
   - Abstract patterns (concept, always, should, etc.) → +2 analytical score
   - Concrete patterns (today, said, at work, etc.) → +1 emotional score
   - Tests for presence of abstract/concrete language patterns

7. **Punctuation-Based Scoring** - Expression intensity
   - Exclamation marks (!) → +1 emotional score per mark
   - Question marks (?) → +0.5 analytical score per mark
   - Reflects emotional expressiveness vs analytical inquiry

8. **Previous Reflection History** - Contextual scoring
   - Analyzes last 3 previous reflections if provided
   - Previous emotional markers → +0.3 emotional score per marker
   - Previous analytical markers → +0.3 analytical score per marker
   - Provides consistency across user's reflection history

9. **Edge Cases**
   - Empty string → balanced, low confidence
   - Single word → balanced, low confidence
   - All caps emotional text → feelers (case-insensitive matching)
   - Mixed markers (equal emotional and analytical) → balanced
   - Low total score (<2) → balanced, confidence 0.3

10. **Marker Detection Accuracy**
   - EMOTIONAL_MARKERS array properly detected (feel, hurt, pain, scared, etc.)
   - ANALYTICAL_MARKERS array properly detected (think, reason, logic, analyze, etc.)
   - Word boundary matching (no partial matches)
   - Case-insensitive matching

**Expected Patterns:**
- Confidence score: 0.0 to 1.0 range
- Higher marker count = higher confidence
- Balanced mode is safe default
- Classification directly affects conversational AI tone adaptation
  </behavior>
  <implementation>
Follow TDD RED-GREEN-REFACTOR cycle:

**RED Phase:**
1. Create test file server/__tests__/toneClassifier.test.ts
2. Write failing tests for classifyTone function
3. Test all three tone modes (feelers, thinkers, balanced)
4. Include edge cases (empty, single word, mixed markers)
5. Run tests - verify failures
6. Commit: `test(02-06): add failing tests for toneClassifier`

**GREEN Phase:**
1. Review test failures - toneClassifier.ts already implemented
2. Verify tests validate tone classification behavior
3. Run tests - should pass
4. Check coverage >80% for toneClassifier.ts
5. Commit: `test(02-06): verify toneClassifier test coverage`

**REFACTOR Phase (if needed):**
1. Extract test case data into fixtures
2. Add test descriptions explaining classification logic
3. Group tests by classification mode
4. Run tests - must still pass
5. Commit only if changes: `refactor(02-06): improve toneClassifier test clarity`

**Coverage Target:** >80% for toneClassifier.ts

**Mocking Strategy:**
- No external dependencies (pure function)
- Use realistic user input samples
- Test both marker arrays (EMOTIONAL_MARKERS, ANALYTICAL_MARKERS)
  </implementation>
</feature>

<verification>
Run test suite:
```bash
npm test -- toneClassifier.test.ts
```

Check coverage:
```bash
npm test -- --coverage --testPathPattern=toneClassifier
```

Success criteria:
- All tests passing
- >80% coverage for toneClassifier.ts
- All three tone modes tested (feelers, thinkers, balanced)
- Edge cases covered
- Marker detection validated
</verification>

<success_criteria>
1. Test file exists at server/__tests__/toneClassifier.test.ts
2. classifyTone function fully tested
3. All tone modes covered (feelers, thinkers, balanced)
4. Confidence scoring validated
5. Edge cases tested (empty input, mixed markers, high marker count)
6. Marker arrays (EMOTIONAL_MARKERS, ANALYTICAL_MARKERS) validated
7. >80% code coverage for toneClassifier.ts
8. All tests passing
9. Test code is clear and well-organized
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-test-coverage/02-06-SUMMARY.md`
</output>
