---
phase: 02-server-test-coverage
plan: 05
type: tdd
wave: 1
depends_on: []
files_modified:
  - server/__tests__/canonical-orchestrator.test.ts
autonomous: true

must_haves:
  truths:
    - "Every AI response passes through safety pipeline (charter, tone, state, pacing, Islamic content)"
    - "Failed validations trigger appropriate fallback responses"
    - "Orchestration audit trail captures all pipeline stages"
  artifacts:
    - path: "server/__tests__/canonical-orchestrator.test.ts"
      provides: "Comprehensive orchestrator tests"
      min_lines: 150
      exports: []
  key_links:
    - from: "server/__tests__/canonical-orchestrator.test.ts"
      to: "server/canonical-orchestrator.ts"
      via: "import CanonicalOrchestrator or enforceCanonicalOrchestration"
      pattern: "import.*(CanonicalOrchestrator|enforceCanonicalOrchestration).*from.*canonical-orchestrator"
---

<objective>
Add comprehensive unit tests for server/canonical-orchestrator.ts - the critical safety pipeline that validates every AI response.

Purpose: Ensure no AI response bypasses safety checks - this is the core protection mechanism for HIPAA and Charter compliance.

Output: Complete test suite covering all pipeline stages and failure modes.
</objective>

<execution_context>
@C:\Users\richa\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\richa\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-server-test-coverage/02-CONTEXT.md
@server/canonical-orchestrator.ts
@server/__tests__/tone-compliance-checker.test.ts
@server/__tests__/conversational-ai.test.ts
</context>

<feature>
  <name>Canonical Orchestrator Test Suite</name>
  <files>
    - server/__tests__/canonical-orchestrator.test.ts
    - server/canonical-orchestrator.ts
  </files>
  <behavior>
**Test Coverage Areas:**

1. **Successful Orchestration Flow**
   - Pre-processing passes
   - AI generation completes successfully
   - Charter validation passes
   - Tone validation passes
   - State validation passes
   - Pacing validation passes
   - Islamic governance passes
   - Returns success=true with AI response
   - Audit trail shows all stages "passed"

2. **Charter Validation Failures**
   - AI response violates charter (judgment, pressure, harmful content)
   - Pipeline blocks response
   - Fallback response returned
   - Audit trail shows charterValidation: "failed"
   - Telemetry event recorded

3. **Tone Compliance Failures**
   - AI response has non-compliant tone (harsh, judgmental)
   - Pipeline blocks response
   - Fallback response returned
   - Audit trail shows toneValidation: "failed"
   - Success=false

4. **Pacing Violations**
   - Response exceeds maxResponseLength for distress level
   - Pipeline enforces truncation or blocks
   - Audit trail shows pacingValidation: "failed"

5. **AI Generation Failures**
   - aiResponseGenerator throws error
   - Pipeline catches error gracefully
   - Fallback response returned
   - Audit trail shows aiGeneration: "failed"
   - No exception propagates

6. **Islamic Content Integration**
   - Appropriate Quran/Hadith selected for context
   - Content passed to aiResponseGenerator
   - Governance validates Islamic content usage
   - Audit trail shows islamicGovernance: "passed"

7. **Telemetry Events**
   - Success events recorded
   - Failure events recorded with reasons
   - Pipeline stages tracked
   - Event data includes user context (emotionalState, distressLevel, mode)

**Expected Patterns:**
- NO EXCEPTIONS: Every response goes through full pipeline
- Fail-safe: Pipeline failures â†’ fallback responses, never propagate errors
- Audit trail: Complete visibility into why response passed/failed
- Telemetry: All events captured for monitoring
  </behavior>
  <implementation>
Follow TDD RED-GREEN-REFACTOR cycle:

**RED Phase:**
1. Create test file server/__tests__/canonical-orchestrator.test.ts
2. Write failing tests for CanonicalOrchestrator.orchestrate() and enforceCanonicalOrchestration()
3. Mock dependencies: SafetyPipeline, FailureLanguage, SafetyTelemetry
4. Test happy path + all failure modes
5. Run tests - verify failures indicate test structure works
6. Commit: `test(02-05): add failing tests for canonical-orchestrator`

**GREEN Phase:**
1. Review test failures - canonical-orchestrator.ts already exists
2. Verify tests validate actual orchestration behavior
3. Run tests - should pass with real implementation
4. Check coverage >80% for canonical-orchestrator.ts
5. Commit: `test(02-05): verify canonical-orchestrator test coverage`

**REFACTOR Phase (if needed):**
1. Extract test fixtures for common orchestration inputs
2. Add helper functions for mock setup
3. Improve test organization (group by pipeline stage)
4. Run tests - must still pass
5. Commit only if changes: `refactor(02-05): improve orchestrator test structure`

**Coverage Target:** >80% for canonical-orchestrator.ts

**Mocking Strategy:**
- Mock SafetyPipeline.validateInput and SafetyPipeline.validateOutput
- Mock FailureLanguage.getFailureResponse
- Mock SafetyTelemetry.recordEvent
- Mock aiResponseGenerator function (test double)
- Use realistic orchestration inputs matching production patterns
  </implementation>
</feature>

<verification>
Run test suite:
```bash
npm test -- canonical-orchestrator.test.ts
```

Check coverage:
```bash
npm test -- --coverage --testPathPattern=canonical-orchestrator
```

Success criteria:
- All tests passing
- >80% coverage for canonical-orchestrator.ts
- All pipeline stages tested (charter, tone, state, pacing, Islamic governance)
- All failure modes tested (charter fail, tone fail, AI generation fail, etc.)
- Fallback responses verified
- Audit trail validation complete
</verification>

<success_criteria>
1. Test file exists at server/__tests__/canonical-orchestrator.test.ts
2. CanonicalOrchestrator.orchestrate() and enforceCanonicalOrchestration() fully tested
3. All 7 pipeline stages covered (pre-processing, AI generation, charter, tone, state, pacing, Islamic governance)
4. All failure modes tested and verified to return fallback responses
5. Audit trail structure validated
6. Telemetry events verified
7. >80% code coverage for canonical-orchestrator.ts
8. All tests passing
9. Test code uses proper mocks and realistic test data
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-test-coverage/02-05-SUMMARY.md`
</output>
