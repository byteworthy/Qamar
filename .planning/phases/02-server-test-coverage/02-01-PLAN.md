---
phase: 02-server-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/__tests__/routes.test.ts
autonomous: true

must_haves:
  truths:
    - "server/routes.ts has unit tests covering >80% of lines"
    - "All API endpoints have test coverage"
    - "Tests verify both success and error cases"
  artifacts:
    - path: "server/__tests__/routes.test.ts"
      provides: "Comprehensive route tests"
      contains: "describe.*routes"
---

<objective>
Add comprehensive unit tests for server/routes.ts (1,351 lines) targeting 80%+ coverage.

Purpose: Establish test safety net for largest server file before any refactoring.

Output: New test file with tests for all major API endpoints.
</objective>

<execution_context>
@C:\Users\richa\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\richa\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@server/routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create routes test file structure</name>
  <files>server/__tests__/routes.test.ts</files>
  <action>
Create server/__tests__/routes.test.ts with test structure for major endpoint groups:

```typescript
import request from 'supertest';
import express from 'express';
import { setupRoutes } from '../routes';

describe('API Routes', () => {
  let app: express.Application;

  beforeEach(() => {
    app = express();
    app.use(express.json());
    setupRoutes(app);
  });

  describe('Health Check', () => {
    it('should return 200 for /api/health', async () => {
      const res = await request(app).get('/api/health');
      expect(res.status).toBe(200);
    });
  });

  describe('Reflection Routes', () => {
    // Tests for /api/reflections endpoints
  });

  describe('User Routes', () => {
    // Tests for /api/user endpoints
  });

  describe('AI Routes', () => {
    // Tests for /api/ai endpoints
  });
});
```
  </action>
  <verify>
- File exists at server/__tests__/routes.test.ts
- npm test runs without errors
  </verify>
  <done>Test file structure created</done>
</task>

<task type="auto">
  <name>Task 2: Add reflection endpoint tests</name>
  <files>server/__tests__/routes.test.ts</files>
  <action>
Add tests for reflection endpoints (GET /api/reflections, POST /api/reflections, etc.):

- Test successful reflection creation
- Test validation errors
- Test authentication requirements
- Test reflection retrieval
- Test pagination
  </action>
  <verify>
- npm test passes
- Coverage for reflection routes >80%
  </verify>
  <done>Reflection endpoints tested</done>
</task>

<task type="auto">
  <name>Task 3: Add AI endpoint tests</name>
  <files>server/__tests__/routes.test.ts</files>
  <action>
Add tests for AI endpoints:

- Test /api/ai/generate endpoint
- Test request validation
- Test error handling
- Test rate limiting
- Mock AI service responses
  </action>
  <verify>
- npm test passes
- AI endpoints have test coverage
  </verify>
  <done>AI endpoints tested</done>
</task>

<task type="auto">
  <name>Task 4: Run coverage report</name>
  <files>server/__tests__/routes.test.ts</files>
  <action>
Run test coverage:

```bash
npm test -- --coverage --collectCoverageFrom=server/routes.ts
```

Verify coverage is >80% for routes.ts
  </action>
  <verify>
- Coverage report shows >80% for routes.ts
- All tests passing
  </verify>
  <done>Coverage target met for routes.ts</done>
</task>

</tasks>

<verification>
1. npm test passes
2. Coverage report shows >80% for server/routes.ts
3. Major endpoints have test coverage
</verification>

<success_criteria>
1. server/__tests__/routes.test.ts created
2. >80% line coverage for server/routes.ts
3. All major endpoints tested
4. Tests pass in CI
5. Code committed with TEST-01 reference
</success_criteria>

<output>
After completion, create .planning/phases/02-server-test-coverage/02-01-SUMMARY.md
</output>
