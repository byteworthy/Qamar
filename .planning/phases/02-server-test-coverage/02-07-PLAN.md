---
phase: 02-server-test-coverage
plan: 07
type: tdd
wave: 1
depends_on: []
files_modified:
  - server/__tests__/stateInference.test.ts
autonomous: true

must_haves:
  truths:
    - "State inference correctly identifies user's inner emotional state from text patterns"
    - "Confidence scoring reflects pattern match quality"
    - "All 11 inner states can be detected from appropriate inputs"
  artifacts:
    - path: "server/__tests__/stateInference.test.ts"
      provides: "Comprehensive state inference tests"
      min_lines: 120
      exports: []
  key_links:
    - from: "server/__tests__/stateInference.test.ts"
      to: "server/stateInference.ts"
      via: "import inferState"
      pattern: "import.*inferState.*from.*stateInference"
---

<objective>
Add comprehensive unit tests for server/stateInference.ts covering all 11 inner emotional states and pattern matching logic.

Purpose: Ensure accurate emotional state detection - drives appropriate Islamic context and therapeutic response framing.

Output: Complete test suite covering all inner states and edge cases.
</objective>

<execution_context>
@C:\Users\richa\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\richa\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-server-test-coverage/02-CONTEXT.md
@server/stateInference.ts
@server/__tests__/conversational-ai.test.ts
</context>

<feature>
  <name>State Inference Test Suite</name>
  <files>
    - server/__tests__/stateInference.test.ts
    - server/stateInference.ts
  </files>
  <behavior>
**Test Coverage Areas:**

1. **Tightness Around Provision** - Financial anxiety detection
   - Input: "I'm so worried about money and can't afford bills"
   - Expected: state="tightness_around_provision", confidence >0.6
   - Patterns: money, bills, afford, broke, financial, rizq, provision
   - Islamic context: Rizq/sustenance language triggers state

2. **Fear of Loss** - Loss anxiety detection
   - Input: "I'm terrified of losing them, afraid they'll leave me"
   - Expected: state="fear_of_loss", confidence >0.6
   - Patterns: lose, losing, afraid of losing, taken away, death, dying

3. **Shame After Sin** - Post-sin guilt detection
   - Input: "I sinned again, feel so ashamed, how can Allah forgive me"
   - Expected: state="shame_after_sin", confidence >0.7
   - Patterns: sin, sinned, ashamed, shame, guilt, Allah forgive, unworthy

4. **Guilt Without Clarity** - Vague guilt detection
   - Input: "I feel bad but I'm not sure what I did wrong"
   - Expected: state="guilt_without_clarity", confidence >0.5
   - Patterns: feel bad, not sure what, can't pinpoint, vague sense

5. **Justified Anger** - Righteous anger detection
   - Input: "They hurt me and it's so unfair, I'm furious"
   - Expected: state="justified_anger", confidence >0.6
   - Patterns: unfair, unjust, angry, hurt me, betrayed, deserve

6. **Feeling Unseen** - Invisibility/loneliness detection
   - Input: "No one sees me, I'm alone, does anyone care"
   - Expected: state="feeling_unseen", confidence >0.6
   - Patterns: no one, nobody, alone, invisible, ignored, doesn't care

7. **Confusion About Effort vs Control** - Helplessness detection
   - Input: "I've tried everything, nothing works, it's out of my control"
   - Expected: state="confusion_effort_control", confidence >0.7
   - Patterns: tried, trying, nothing works, out of control, what else can I do

8. **Decision Paralysis** - Indecision detection
   - Input: "I can't decide, every option seems wrong, stuck"
   - Expected: state="decision_paralysis", confidence >0.6
   - Patterns: can't decide, stuck, don't know what to do, paralyzed

9. **Grief and Sadness** - Grief detection
   - Input: "I'm so sad and heartbroken, just crying all the time"
   - Expected: state="grief_and_sadness", confidence >0.6
   - Patterns: sad, sadness, grief, heartbroken, crying, tears, mourning

10. **Social Anxiety** - Social fear detection
    - Input: "I'm so anxious around people, afraid of judgment"
    - Expected: state="social_anxiety", confidence >0.6
    - Patterns: anxious around people, social, afraid of judgment, awkward

11. **Overwhelming Gratitude** - Positive state detection
    - Input: "I'm so grateful to Allah, overwhelmed by His blessings"
    - Expected: state="overwhelming_gratitude", confidence >0.7
    - Patterns: grateful, gratitude, blessed, blessings, Alhamdulillah

12. **Unknown State** - Fallback detection
    - Input: "Just checking in"
    - Expected: state="unknown", confidence low
    - No strong pattern matches

13. **Confidence Scoring**
    - Multiple pattern matches → higher confidence
    - Single pattern match → moderate confidence
    - No matches → low confidence, unknown state
    - Confidence range: 0.0 to 0.9

14. **Edge Cases**
    - Empty string → unknown, confidence 0
    - Very long text with mixed patterns → highest confidence state wins
    - Case-insensitive matching
    - Word boundary matching (no partial matches)

**Expected Patterns:**
- Each inner state maps to specific regex patterns
- More pattern matches = higher confidence
- Unknown is safe fallback
- State detection guides Islamic content selection and therapeutic framing
  </behavior>
  <implementation>
Follow TDD RED-GREEN-REFACTOR cycle:

**RED Phase:**
1. Create test file server/__tests__/stateInference.test.ts
2. Write failing tests for inferState function
3. Test all 11 inner states with realistic inputs
4. Include confidence scoring tests
5. Add edge cases (empty, mixed patterns, unknown)
6. Run tests - verify failures
7. Commit: `test(02-07): add failing tests for stateInference`

**GREEN Phase:**
1. Review test failures - stateInference.ts already implemented
2. Verify tests validate state inference behavior
3. Run tests - should pass
4. Check coverage >80% for stateInference.ts
5. Commit: `test(02-07): verify stateInference test coverage`

**REFACTOR Phase (if needed):**
1. Extract test fixtures for each inner state
2. Create helper function for state assertion
3. Group tests by inner state category
4. Run tests - must still pass
5. Commit only if changes: `refactor(02-07): improve stateInference test organization`

**Coverage Target:** >80% for stateInference.ts

**Mocking Strategy:**
- No external dependencies (pure function)
- Use realistic user reflection text samples
- Cover Islamic-specific language (rizq, Allah, Alhamdulillah)
- Test both English and Islamic terminology
  </implementation>
</feature>

<verification>
Run test suite:
```bash
npm test -- stateInference.test.ts
```

Check coverage:
```bash
npm test -- --coverage --testPathPattern=stateInference
```

Success criteria:
- All tests passing
- >80% coverage for stateInference.ts
- All 11 inner states tested
- Confidence scoring validated
- Edge cases covered
</verification>

<success_criteria>
1. Test file exists at server/__tests__/stateInference.test.ts
2. inferState function fully tested
3. All 11 inner states covered (tightness_around_provision through overwhelming_gratitude)
4. Unknown state fallback tested
5. Confidence scoring validated for multiple scenarios
6. Edge cases tested (empty input, mixed patterns, long text)
7. Islamic terminology tested (rizq, Allah, Alhamdulillah)
8. >80% code coverage for stateInference.ts
9. All tests passing
10. Test code uses realistic user reflection samples
</success_criteria>

<output>
After completion, create `.planning/phases/02-server-test-coverage/02-07-SUMMARY.md`
</output>
