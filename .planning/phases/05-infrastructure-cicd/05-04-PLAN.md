---
phase: 05-infrastructure-cicd
plan: 04
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - .github/workflows/deploy-preview.yml
autonomous: false

user_setup:
  - service: "Railway"
    why: "Backend hosting platform for preview deployments"
    env_vars:
      - name: RAILWAY_TOKEN
        source: "Railway dashboard ‚Üí Account Settings ‚Üí Tokens ‚Üí Create new token"
        note: "Service token with deployment permissions"
    dashboard_config:
      - task: "Create preview service"
        location: "Railway dashboard ‚Üí New Project ‚Üí Empty Project ‚Üí Add Service"
        note: "Configure service to deploy from GitHub PRs"
      - task: "Configure environment variables"
        location: "Service ‚Üí Variables tab"
        note: "Copy production variables, use test API keys where appropriate"
      - task: "Add GitHub secret RAILWAY_TOKEN"
        location: "GitHub repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
        note: "Add Railway service token as repository secret"

must_haves:
  truths:
    - "Pull requests automatically deploy backend to staging environment"
    - "Backend staging URL is posted as comment on PR"
    - "Frontend clients can test against staging backend by updating EXPO_PUBLIC_DOMAIN"
  artifacts:
    - path: ".github/workflows/deploy-preview.yml"
      provides: "Automated staging deployment workflow"
      contains: "railway"
      min_lines: 50
  key_links:
    - from: ".github/workflows/deploy-preview.yml"
      to: "Railway preview service"
      via: "Railway API"
      pattern: "railway.*deploy"
    - from: "PR comment"
      to: "Staging URL"
      via: "GitHub API"
      pattern: "Preview deployed"
---

<objective>
Implement automated deployment of backend PR changes to Railway staging environment for testing before merge.

Purpose: Enable testing of backend changes in production-like environment before merge. Developers can point local/test clients to staging backend URL to validate API changes. Catches environment-specific issues early.

Output: GitHub Actions workflow that deploys backend to Railway preview service on every PR, posts staging URL in PR comments.

Note: This plan covers backend-only staging deployment. Frontend staging (iOS/Android test builds via EAS) is handled separately through Expo's built-in PR preview system.
</objective>

<execution_context>
@C:\Users\richa\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\richa\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STACK.md

# Deployment context
Current stack: Express backend hosted on Railway, Expo mobile app via EAS

# Build scripts
@package.json - server:build, server:prod scripts

# Requirements context
INFRA-03: Implement automated deployment to staging on PR

# Railway is already used for production backend hosting
# This plan adds preview deployments for PRs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Railway preview deployment workflow</name>
  <files>.github/workflows/deploy-preview.yml</files>
  <action>
Create `.github/workflows/deploy-preview.yml` to automatically deploy backend to Railway preview service on PR:

```yaml
name: Deploy Preview

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths:
      # Only deploy when backend code changes
      - 'server/**'
      - 'shared/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/deploy-preview.yml'

jobs:
  deploy:
    name: Deploy to Railway Preview
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway Preview
        run: railway up --service=${{ secrets.RAILWAY_PREVIEW_SERVICE_ID }} --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Get Preview URL
        id: preview
        run: |
          sleep 30  # Wait for deployment to be ready
          PREVIEW_URL=$(railway status --service=${{ secrets.RAILWAY_PREVIEW_SERVICE_ID }} --json | jq -r '.url')
          echo "url=$PREVIEW_URL" >> $GITHUB_OUTPUT
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Post Preview URL to PR
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.preview.outputs.url }}';
            const comment = `## üöÄ Preview Deployment

            Backend preview deployed successfully!

            **Preview URL:** ${previewUrl}

            ### Testing Instructions
            1. Update \`EXPO_PUBLIC_DOMAIN\` in your local client to point to preview URL
            2. Run \`npm run expo:dev\` to test against preview backend
            3. Test your PR changes end-to-end

            Preview will be available until PR is closed or merged.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Deploy Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Preview deployed successfully"
          else
            echo "‚ùå Preview deployment failed"
          fi
```

Why Railway: Already used for production hosting. Preview services are isolated environments with own URLs and databases.

Why path filters: Only deploy when backend code changes. Avoid unnecessary deploys for client-only changes.

Why PR comment: Makes preview URL immediately visible without digging through workflow logs. Includes testing instructions.

Why detach flag: Allows deployment to continue in background. Workflow doesn't wait for full startup.

Why if condition: Only deploy from PRs in same repository, not from forks (prevents token exposure).
  </action>
  <verify>
This task requires Railway setup to be complete before verification. See checkpoint task below.

Once setup is complete:
1. Create test PR with backend change (e.g., add comment to server/index.ts)
2. Verify "Deploy Preview" workflow triggers
3. Check workflow logs for "railway up" command execution
4. Verify PR comment appears with preview URL
5. Visit preview URL and verify backend responds
6. Test API endpoint: curl https://preview-url.railway.app/api/health

Expected outcome: Workflow completes in ~2-3 minutes, PR comment includes working preview URL, backend is accessible.
  </verify>
  <done>
- Railway preview deployment workflow created
- Deploys automatically when PR affects backend code
- Posts preview URL as PR comment with testing instructions
- Uses Railway CLI for deployment via RAILWAY_TOKEN
- Path filters prevent unnecessary deploys
- Workflow only runs for same-repository PRs (security)
- Preview URLs are unique per PR
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Set up Railway preview service and GitHub secrets</action>
  <instructions>

### Step 1: Create Railway Preview Service

1. Log in to Railway dashboard: https://railway.app
2. Navigate to your existing Noor backend project
3. Click "New Service" ‚Üí "Empty Service"
4. Name it "noor-backend-preview"
5. Go to Settings tab:
   - Set "Source" to GitHub repository (same as production)
   - Enable "Deploy on PR" option
   - Set root directory to "." (project root)
   - Set build command: `npm run server:build`
   - Set start command: `npm run server:prod`
6. Go to Variables tab:
   - Copy all environment variables from production service
   - Update these variables for staging:
     - `NODE_ENV`: Set to "staging"
     - `ANTHROPIC_API_KEY`: Use test API key or same as production
     - `STRIPE_SECRET_KEY`: Use Stripe test mode key
     - `STRIPE_WEBHOOK_SECRET`: Use test mode webhook secret
     - `DATABASE_URL`: Create separate preview database or use same as production (with caution)
   - Keep these variables same as production:
     - `SESSION_SECRET`
     - `ENCRYPTION_KEY`
     - `SENTRY_DSN` (optional)
7. Note the Service ID (found in Settings tab URL or via Railway CLI)

### Step 2: Get Railway API Token

1. Go to Railway Account Settings: https://railway.app/account
2. Click "Tokens" tab
3. Click "Create new token"
4. Give it a descriptive name: "GitHub Actions - Preview Deployments"
5. Copy the generated token (you won't see it again)

### Step 3: Add GitHub Secrets

1. Go to GitHub repository: https://github.com/[username]/Noor-CBT
2. Navigate to Settings ‚Üí Secrets and variables ‚Üí Actions
3. Click "New repository secret"
4. Add two secrets:
   - Name: `RAILWAY_TOKEN`
     Value: [token from Step 2]
   - Name: `RAILWAY_PREVIEW_SERVICE_ID`
     Value: [service ID from Step 1]
5. Click "Add secret" for each

### Step 4: Verify Setup

1. Create a test PR with a small backend change
2. Check GitHub Actions tab for "Deploy Preview" workflow
3. Verify workflow runs and completes successfully
4. Check PR comments for preview URL
5. Visit preview URL and test /api/health endpoint

### Estimated Cost

Railway preview service costs:
- Hobby plan: $5/month per service
- Usage-based: ~$0.000463 per GB-hour
- Typical PR preview: ~$0.50-$2 per month with moderate usage

Alternative: Use Railway's PR deployment feature (included in Hobby plan) instead of separate preview service. This auto-deploys PRs with unique URLs.

  </instructions>
  <resume-signal>
Type "railway setup complete" when Railway preview service is created and GitHub secrets are added, or describe any issues.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Add deployment status badge to README</name>
  <files>README.md</files>
  <action>
Add deployment workflow status badges to README.md to show CI/CD health at a glance.

If README.md exists, add badges at the top (after title):
```markdown
# Noor App

![CI](https://github.com/[username]/Noor-CBT/workflows/CI/badge.svg)
![E2E Tests](https://github.com/[username]/Noor-CBT/workflows/E2E%20Tests/badge.svg)
![Security Analysis](https://github.com/[username]/Noor-CBT/workflows/Security%20Analysis/badge.svg)
![Deploy Preview](https://github.com/[username]/Noor-CBT/workflows/Deploy%20Preview/badge.svg)

Islamic-integrated CBT mobile application...
```

Replace [username] with actual GitHub username or organization name.

If README.md doesn't exist at project root, create it with:
```markdown
# Noor App

![CI](https://github.com/[username]/Noor-CBT/workflows/CI/badge.svg)
![E2E Tests](https://github.com/[username]/Noor-CBT/workflows/E2E%20Tests/badge.svg)
![Security Analysis](https://github.com/[username]/Noor-CBT/workflows/Security%20Analysis/badge.svg)
![Deploy Preview](https://github.com/[username]/Noor-CBT/workflows/Deploy%20Preview/badge.svg)

## Overview

Islamic-integrated Cognitive Behavioral Therapy (CBT) mobile application built with React Native/Expo and Express.js backend.

## CI/CD Status

All workflows run automatically on pull requests to ensure code quality and prevent regressions.

- **CI**: Type checking, linting, unit tests, coverage enforcement
- **E2E Tests**: Detox end-to-end tests on iOS simulator
- **Security Analysis**: CodeQL SAST scanning
- **Deploy Preview**: Automatic staging deployment for testing

## Development

See individual directories for development instructions:
- `client/` - React Native mobile app
- `server/` - Express.js backend
- `e2e/` - Detox E2E tests
```

Why badges: Immediate visual feedback on CI/CD health. Badges update automatically based on workflow status (green = passing, red = failing).
  </action>
  <verify>
1. Read README.md and verify badges are present
2. Visit repository on GitHub and verify badges display correctly
3. Click each badge to verify it links to corresponding workflow
4. Verify badge shows green checkmark (passing) or red X (failing)

Expected outcome: Four workflow status badges visible at top of README, all showing current status.
  </verify>
  <done>
- Workflow status badges added to README.md
- Badges show CI, E2E Tests, Security Analysis, and Deploy Preview status
- Badges update automatically based on workflow runs
- README provides overview of CI/CD automation
- Links to workflows from badges for quick access
  </done>
</task>

</tasks>

<verification>
1. Railway preview service created and configured
2. GitHub secrets (RAILWAY_TOKEN, RAILWAY_PREVIEW_SERVICE_ID) added
3. Deploy Preview workflow exists and triggers on backend PRs
4. Workflow deploys to Railway successfully
5. PR comment appears with preview URL
6. Preview URL is accessible and backend responds
7. Path filters prevent deploys on client-only changes
8. Status badges appear in README
</verification>

<success_criteria>
1. Deploy Preview workflow created and configured
2. Railway preview service receives automatic deployments on PR
3. Preview URL posted as comment on every PR with backend changes
4. Preview environment includes proper test API keys and environment variables
5. Workflow completes in 2-5 minutes
6. Preview URLs are unique per PR and accessible
7. Status badges in README show current CI/CD health
8. Preview deployments only run for same-repository PRs (security)
</success_criteria>

<output>
After completion, create `.planning/phases/05-infrastructure-cicd/05-04-SUMMARY.md`
</output>
