---
phase: 05-infrastructure-cicd
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/security.yml
  - .github/dependabot.yml
autonomous: true

must_haves:
  truths:
    - "SAST scanner runs on every PR and catches security issues"
    - "Dependabot creates weekly PRs for dependency updates"
    - "Security vulnerabilities are detected before merge"
  artifacts:
    - path: ".github/workflows/security.yml"
      provides: "SAST security scanning workflow"
      contains: "CodeQL"
      min_lines: 40
    - path: ".github/dependabot.yml"
      provides: "Automated dependency update configuration"
      contains: "package-ecosystem: npm"
  key_links:
    - from: ".github/workflows/security.yml"
      to: "GitHub Security tab"
      via: "CodeQL analysis"
      pattern: "github/codeql-action"
    - from: ".github/dependabot.yml"
      to: "Pull requests"
      via: "automated PRs"
      pattern: "schedule:"
---

<objective>
Implement automated security scanning and dependency updates to catch vulnerabilities early.

Purpose: Proactively detect security issues through static analysis (SAST) and keep dependencies up-to-date with automated weekly updates. This reduces security risk and prevents vulnerable dependencies from accumulating.

Output: CodeQL SAST workflow running on every PR, Dependabot creating weekly dependency update PRs.
</objective>

<execution_context>
@C:\Users\richa\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\richa\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STACK.md

# Technology stack
- Node.js backend with Express
- React Native/Expo frontend
- TypeScript throughout
- Security-sensitive: handles HIPAA-protected health data

# Existing CI workflows
@.github/workflows/ci.yml
@.github/workflows/pr-check.yml

# Requirements context
INFRA-04: Add security scanning (SAST) to CI/CD
INFRA-05: Enable Dependabot for automated dependency updates
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CodeQL SAST workflow</name>
  <files>.github/workflows/security.yml</files>
  <action>
Create `.github/workflows/security.yml` to run CodeQL static analysis security testing:

```yaml
name: Security Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Mondays at 6 AM UTC
    - cron: '0 6 * * 1'

jobs:
  codeql:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ['javascript', 'typescript']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
```

Why CodeQL: GitHub's native SAST tool, excellent JavaScript/TypeScript support, automatically integrated with GitHub Security tab, detects common vulnerabilities (SQL injection, XSS, path traversal, etc.).

Why security-extended queries: Includes additional security checks beyond default set. More thorough analysis with acceptable false positive rate.

Why scheduled runs: Weekly scans catch new vulnerabilities in existing code as CodeQL database updates.
  </action>
  <verify>
1. Push workflow to repository
2. Navigate to GitHub repository → Actions tab
3. Verify "Security Analysis" workflow appears and runs
4. Check GitHub Security tab → Code scanning alerts for any detected issues
5. Create test PR and verify CodeQL scan runs automatically
6. Review job logs for "CodeQL database created" and "Analysis completed" messages

Expected outcome: Workflow runs successfully, CodeQL analysis completes in ~3-5 minutes, results appear in Security tab.
  </verify>
  <done>
- CodeQL SAST workflow created and enabled
- Scans JavaScript and TypeScript codebases
- Runs on every push to main, every PR, and weekly schedule
- Security findings appear in GitHub Security tab
- Catches common vulnerabilities: injection, XSS, insecure crypto, path traversal
- security-extended query set provides comprehensive coverage
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Dependabot for dependency updates</name>
  <files>.github/dependabot.yml</files>
  <action>
Create `.github/dependabot.yml` to enable automated dependency updates:

```yaml
version: 2
updates:
  # npm dependencies (root package.json)
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "06:00"
      timezone: "UTC"
    open-pull-requests-limit: 5
    groups:
      # Group Expo dependencies together
      expo:
        patterns:
          - "expo*"
          - "@expo/*"
      # Group React dependencies together
      react:
        patterns:
          - "react"
          - "react-*"
      # Group testing dependencies
      testing:
        patterns:
          - "jest*"
          - "@testing-library/*"
          - "detox"
      # Group TypeScript tooling
      typescript:
        patterns:
          - "typescript"
          - "@types/*"
          - "ts-*"
    labels:
      - "dependencies"
      - "automated"
    reviewers:
      - "richa"
    assignees:
      - "richa"
    commit-message:
      prefix: "deps"
      include: "scope"

  # GitHub Actions updates
  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "monday"
      time: "06:00"
      timezone: "UTC"
    open-pull-requests-limit: 2
    labels:
      - "dependencies"
      - "ci/cd"
```

Why grouped updates: Reduces PR noise by combining related dependencies. Easier to review and test (e.g., all Expo packages update together to maintain compatibility).

Why weekly schedule: Balances staying current with avoiding update fatigue. Monday 6 AM UTC means updates are ready for review at start of week.

Why PR limits: Prevents overwhelming number of PRs. 5 for npm (with grouping), 2 for GitHub Actions is manageable.

Why include GitHub Actions: Keeps CI/CD actions up-to-date with security patches and new features.
  </action>
  <verify>
1. Push dependabot.yml to repository
2. Navigate to GitHub repository → Insights → Dependency graph → Dependabot
3. Verify Dependabot is enabled and configuration is valid
4. Check for "Last checked: X minutes ago" status
5. Wait for next Monday 6 AM UTC or manually trigger via repository settings
6. Verify Dependabot creates PRs for outdated dependencies

Expected outcome: Dependabot creates grouped PRs (e.g., "Bump expo group from 54.0.0 to 54.1.0") with automatic changelogs and compatibility notes.

To test immediately: Temporarily change schedule to "interval: daily" and push. Dependabot will check within hours and create PRs.
  </verify>
  <done>
- Dependabot configured for npm and GitHub Actions ecosystems
- Weekly update schedule (Monday 6 AM UTC)
- Dependency updates grouped by category (Expo, React, testing, TypeScript)
- PR limit prevents overwhelming number of updates
- Automatic labels, reviewers, and commit message formatting
- Dependabot creates PRs with changelogs and compatibility information
  </done>
</task>

<task type="auto">
  <name>Task 3: Document security scanning and dependency update process</name>
  <files>.github/workflows/security.yml, .github/dependabot.yml</files>
  <action>
Add inline documentation comments to both configuration files to explain the security automation setup.

In `.github/workflows/security.yml`, add header comments:
```yaml
# Security Analysis Workflow
#
# This workflow runs CodeQL static analysis security testing (SAST) to detect
# security vulnerabilities in JavaScript and TypeScript code.
#
# Triggers:
# - Every push to main branch
# - Every pull request to main branch
# - Weekly schedule (Mondays at 6 AM UTC)
#
# What it detects:
# - SQL injection, XSS, path traversal
# - Insecure cryptography
# - Command injection
# - Unsafe deserialization
# - Authentication/authorization issues
#
# Results appear in: GitHub Security tab → Code scanning alerts
```

In `.github/dependabot.yml`, add header comments:
```yaml
# Dependabot Configuration
#
# Automatically creates pull requests to update dependencies weekly.
# This keeps the project secure by updating packages with known vulnerabilities.
#
# Schedule: Every Monday at 6 AM UTC
# PR limits: 5 for npm, 2 for GitHub Actions (prevents overwhelming number of PRs)
# Grouping: Related dependencies updated together (Expo, React, testing, TypeScript)
#
# Review process:
# 1. Dependabot creates PR with changelog
# 2. CI runs tests automatically
# 3. Review changes and approve if tests pass
# 4. Merge to apply updates
```

Why document: Future maintainers understand purpose and configuration. Comments explain scheduling decisions, grouping strategy, and workflow.
  </action>
  <verify>
Read both configuration files and verify:
1. Header comments explain workflow purpose and behavior
2. Trigger conditions are documented
3. Detected vulnerability types are listed for CodeQL
4. Dependabot review process is explained
5. Comments are clear and actionable

Run: `cat .github/workflows/security.yml | head -20` to verify header comment exists
Run: `cat .github/dependabot.yml | head -20` to verify header comment exists
  </verify>
  <done>
- Both configuration files have comprehensive header documentation
- CodeQL workflow explains SAST capabilities and detected vulnerabilities
- Dependabot configuration explains schedule, grouping, and review process
- Documentation enables future maintainers to understand security automation
- Comments follow YAML syntax conventions
  </done>
</task>

</tasks>

<verification>
1. Push both configuration files to repository
2. Verify CodeQL workflow appears in Actions tab and runs successfully
3. Check GitHub Security tab for Code scanning alerts section
4. Verify Dependabot is enabled in repository Insights → Dependency graph
5. Wait for next Monday or trigger Dependabot manually to verify PR creation
6. Review CodeQL results for any detected security issues
7. Test that CodeQL runs on pull requests
</verification>

<success_criteria>
1. CodeQL SAST workflow created and runs on push/PR/schedule
2. CodeQL scans both JavaScript and TypeScript code
3. Security findings appear in GitHub Security tab
4. Dependabot configuration enables weekly dependency updates
5. Dependency updates grouped by category (Expo, React, testing, TypeScript)
6. Dependabot creates PRs with automatic changelogs
7. Both files have comprehensive documentation comments
8. Security scanning catches known vulnerability patterns
</success_criteria>

<output>
After completion, create `.planning/phases/05-infrastructure-cicd/05-02-SUMMARY.md`
</output>
