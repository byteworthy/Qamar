---
phase: 05-infrastructure-cicd
plan: 03
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - .github/workflows/e2e.yml
  - package.json
autonomous: false

user_setup:
  - service: "GitHub Actions runner"
    why: "iOS simulator requires macOS runner"
    dashboard_config:
      - task: "Review runner usage and costs"
        location: "GitHub repository → Settings → Actions → Runners"
        note: "macOS runners cost 10x Linux runners. E2E tests will increase CI costs."

must_haves:
  truths:
    - "Detox E2E tests run automatically on every PR"
    - "Key user flows are tested end-to-end before merge"
    - "E2E test failures block PR merge"
  artifacts:
    - path: ".github/workflows/e2e.yml"
      provides: "E2E test workflow for CI"
      contains: "detox test"
      min_lines: 60
    - path: "package.json"
      provides: "E2E test scripts"
      contains: "test:e2e"
  key_links:
    - from: ".github/workflows/e2e.yml"
      to: "e2e/*.test.js"
      via: "detox test command"
      pattern: "npm run test:e2e"
    - from: ".github/workflows/e2e.yml"
      to: "Expo dev client build"
      via: "eas build"
      pattern: "eas build.*development"
---

<objective>
Configure Detox E2E tests to run automatically in CI/CD pipeline on every pull request.

Purpose: Catch UI/navigation regressions and critical user flow failures before merge. E2E tests validate the complete application from user perspective, ensuring features work end-to-end across the stack.

Output: GitHub Actions workflow that builds Expo dev client, runs Detox tests on iOS simulator, and reports results in PR checks.
</objective>

<execution_context>
@C:\Users\richa\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\richa\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/STACK.md

# Existing Detox configuration
@.detoxrc.js
@e2e/reflectionFlow.test.js
@e2e/navigation.test.js
@e2e/subscription.test.js

# Package scripts
@package.json

# Requirements context
TEST-09: Configure Detox E2E tests in CI/CD pipeline
INFRA-02: Add automated E2E tests to PR checks

# E2E tests exist and are configured for local development
# This plan adds them to CI/CD for automated execution on every PR
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E2E test workflow for iOS simulator</name>
  <files>.github/workflows/e2e.yml</files>
  <action>
Create `.github/workflows/e2e.yml` to run Detox E2E tests on iOS simulator in CI:

```yaml
name: E2E Tests

on:
  pull_request:
    branches: [main]
    paths:
      # Only run E2E tests when relevant files change
      - 'client/**'
      - 'e2e/**'
      - 'package.json'
      - 'app.json'
      - '.github/workflows/e2e.yml'

jobs:
  e2e-ios:
    name: E2E Tests (iOS Simulator)
    runs-on: macos-14
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Setup iOS Simulator
        run: |
          xcrun simctl boot "iPhone 15 Pro" || true
          xcrun simctl list devices | grep "iPhone 15 Pro"

      - name: Build app for Detox
        run: npm run build:e2e:ios
        env:
          EXPO_PUBLIC_DOMAIN: localhost:5000
          NODE_ENV: test

      - name: Start backend server
        run: |
          npm run server:dev &
          sleep 10
          curl http://localhost:5000/api/health || echo "Server startup check"
        env:
          NODE_ENV: test
          VALIDATION_MODE: true

      - name: Run Detox E2E tests
        run: npm run test:e2e:ios
        env:
          EXPO_PUBLIC_DOMAIN: localhost:5000

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: detox-artifacts
          path: |
            e2e/artifacts/
            ~/Library/Logs/DiagnosticReports/

      - name: Stop backend server
        if: always()
        run: pkill -f "node.*server" || true
```

Why macOS runner: iOS simulator requires macOS. macOS-14 is latest stable.

Why path filters: E2E tests take 15-20 minutes and cost 10x more than Linux runners. Only run when client code, E2E tests, or app config changes. Skip for server-only changes.

Why timeout: Generous 45-minute timeout for build + tests. Typical run: ~20-25 minutes.

Why VALIDATION_MODE: Uses mock responses in CI to avoid external API dependencies (Anthropic, Stripe). Faster and more reliable.

Why artifact upload on failure: Screenshots, logs, and crash reports help debug E2E failures.
  </action>
  <verify>
1. Push workflow to repository and create test PR
2. Verify "E2E Tests" check appears in PR checks
3. Monitor workflow execution in Actions tab
4. Verify iOS simulator boots successfully
5. Verify app builds and installs on simulator
6. Verify tests execute and report results
7. Check for "PASS e2e/reflectionFlow.test.js" in logs

Expected outcome: Workflow completes in ~20-25 minutes, all E2E tests pass, PR check shows green.

To test failure handling: Add `expect(true).toBe(false)` to a test, push, verify workflow fails and uploads artifacts.
  </verify>
  <done>
- E2E test workflow created for iOS simulator on macOS runners
- Workflow runs only when client/E2E code changes (path filters)
- Backend server starts in test mode with VALIDATION_MODE
- Detox tests execute on iPhone 15 Pro simulator
- Test artifacts uploaded on failure for debugging
- Workflow integrated with PR checks (blocks merge on failure)
- 45-minute timeout prevents hanging workflows
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify E2E test coverage and CI scripts</name>
  <files>package.json</files>
  <action>
Verify E2E test scripts in package.json and confirm existing test coverage.

**Verify scripts exist:**
```json
{
  "scripts": {
    "test:e2e:ios": "detox test --configuration ios.sim.debug",
    "build:e2e:ios": "detox build --configuration ios.sim.debug"
  }
}
```

If scripts don't exist, add them. These scripts use the debug configuration from `.detoxrc.js` which builds the Expo dev client with development settings.

**Verify existing E2E test coverage:**
The following test suites already exist and cover key user flows:

1. **e2e/reflectionFlow.test.js** - Core CBT reflection workflow
   - User can navigate to reflection screen
   - User can create a new reflection entry
   - User can submit reflection and see confirmation
   - Reflection data persists and displays in history

2. **e2e/navigation.test.js** - App navigation and tab switching
   - Bottom tab navigation works correctly
   - User can switch between Home, Reflect, Journey, and Settings tabs
   - Screen transitions are smooth and functional
   - Back navigation works correctly

3. **e2e/subscription.test.js** - Premium subscription flow
   - User can view subscription offerings
   - Paywall displays correctly for premium features
   - Subscription UI elements are accessible
   - Premium feature gating works correctly

These tests cover the three critical user flows: core reflection functionality (the app's primary purpose), navigation between major sections, and subscription/monetization.

Why debug configuration: Faster builds than release configuration. Sufficient for E2E test validation. Release builds tested by EAS build workflow.
  </action>
  <verify>
Run locally to verify scripts work:
1. `npm run build:e2e:ios` - should build Expo dev client
2. `npm run test:e2e:ios` - should run Detox tests (requires simulator)

Expected outcome: Both commands execute without errors. Tests may fail if backend isn't running locally, but commands should execute.
  </verify>
  <done>
- E2E test scripts verified in package.json
- build:e2e:ios script builds Expo dev client for testing
- test:e2e:ios script runs Detox tests on iOS simulator
- Scripts use debug configuration from .detoxrc.js
- Scripts work in both local and CI environments
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
E2E test workflow that automatically runs Detox tests on every PR. The workflow:
- Runs on macOS-14 runner with iOS simulator
- Builds Expo dev client
- Starts backend server in test mode
- Executes all E2E tests (reflection flow, navigation, subscription)
- Reports results in PR checks
- Blocks merge on test failures
  </what-built>
  <how-to-verify>
1. Create a test PR with a small change to client code (e.g., update a comment)
2. Navigate to PR checks and verify "E2E Tests" appears
3. Click "Details" to view workflow execution
4. Wait for workflow to complete (~20-25 minutes)
5. Verify all E2E test suites pass:
   - e2e/reflectionFlow.test.js
   - e2e/navigation.test.js
   - e2e/subscription.test.js
6. Check workflow logs for:
   - "iPhone 15 Pro" simulator boot message
   - "PASS e2e/*.test.js" for each test suite
   - "Tests: X passed, X total" summary
7. Verify PR check shows green checkmark

Cost awareness: This workflow uses macOS runners which cost $0.08/minute (10x Linux). Typical run costs ~$2. Monthly cost with 50 PRs: ~$100.

If workflow fails:
- Check "Upload test artifacts" step for screenshots/logs
- Review simulator logs in artifacts
- Verify server started successfully (check curl output)
  </how-to-verify>
  <resume-signal>
Type "e2e tests passing" when E2E workflow successfully runs and passes on a test PR, or describe any issues encountered.
  </resume-signal>
</task>

</tasks>

<verification>
1. E2E workflow file exists at .github/workflows/e2e.yml
2. Workflow triggered by PR to main with path filters
3. iOS simulator boots on macOS runner
4. Expo dev client builds successfully
5. Backend server starts in VALIDATION_MODE
6. All Detox tests execute and pass
7. Test results reported in PR checks
8. Workflow fails if any test fails (blocking merge)
9. Test artifacts uploaded on failure
</verification>

<success_criteria>
1. E2E workflow runs automatically on PRs affecting client code
2. iOS simulator (iPhone 15 Pro) used for testing
3. All E2E test suites execute: reflectionFlow, navigation, subscription
4. PR check shows "E2E Tests" status (green = pass, red = fail)
5. Test failures block PR merge
6. Workflow completes in 20-30 minutes
7. Path filters prevent unnecessary runs (server-only changes skip E2E)
8. Test artifacts available for debugging failures
</success_criteria>

<output>
After completion, create `.planning/phases/05-infrastructure-cicd/05-03-SUMMARY.md`
</output>
