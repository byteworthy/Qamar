---
phase: 09-ui-ux-polish-animation-enhancements
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - client/components/AnimatedModal.tsx
  - client/components/ExitConfirmationModal.tsx
  - client/components/__tests__/AnimatedModal.test.tsx
autonomous: true

must_haves:
  truths:
    - "Modals appear with smooth scale+fade animation"
    - "Modal backdrop fades in smoothly"
    - "ExitConfirmationModal uses AnimatedModal for consistent transitions"
  artifacts:
    - path: "client/components/AnimatedModal.tsx"
      provides: "Reusable animated modal wrapper with scale+fade entrance"
      min_lines: 80
      exports: ["AnimatedModal"]
    - path: "client/components/ExitConfirmationModal.tsx"
      provides: "Exit confirmation using AnimatedModal"
      contains: "AnimatedModal"
    - path: "client/components/__tests__/AnimatedModal.test.tsx"
      provides: "Unit tests for AnimatedModal"
      min_lines: 30
  key_links:
    - from: "client/components/AnimatedModal.tsx"
      to: "react-native-reanimated"
      via: "withSpring, useAnimatedStyle for scale+opacity"
      pattern: "withSpring.*springConfig"
    - from: "client/components/ExitConfirmationModal.tsx"
      to: "client/components/AnimatedModal.tsx"
      via: "imports AnimatedModal"
      pattern: "import.*AnimatedModal.*from"
---

<objective>
Create AnimatedModal component and migrate ExitConfirmationModal

Purpose: Establish reusable modal animation pattern (scale+fade entrance, backdrop fade) and apply it to ExitConfirmationModal - ensuring modal animations are consistent with card animations throughout the app

Output: AnimatedModal.tsx component, updated ExitConfirmationModal.tsx, and tests
</objective>

<execution_context>
@C:\Users\richa\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\richa\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ui-ux-polish-animation-enhancements/09-RESEARCH.md
@client/components/ExitConfirmationModal.tsx
@client/components/GlassCard.tsx
@client/components/Button.tsx
@client/constants/theme.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AnimatedModal component with scale+fade entrance (UX-08)</name>
  <files>client/components/AnimatedModal.tsx</files>
  <action>
Create AnimatedModal.tsx following patterns from research and GlassCard.tsx:

```typescript
/**
 * AnimatedModal Component
 *
 * Reusable modal wrapper with custom reanimated entrance animations.
 * Provides scale+fade entrance and backdrop fade matching the app's
 * contemplative animation philosophy.
 *
 * Usage:
 * <AnimatedModal visible={showModal} onRequestClose={closeModal}>
 *   <View>Modal content here</View>
 * </AnimatedModal>
 */

import React, { useEffect } from "react";
import { View, StyleSheet, Modal, Pressable, ViewStyle } from "react-native";
import Animated, {
  useAnimatedStyle,
  useSharedValue,
  withSpring,
  withTiming,
  WithSpringConfig,
} from "react-native-reanimated";
import { useTheme } from "@/hooks/useTheme";
import { BorderRadius, Spacing, Shadows } from "@/constants/theme";

interface AnimatedModalProps {
  visible: boolean;
  onRequestClose: () => void;
  children: React.ReactNode;
  contentStyle?: ViewStyle;
  /** Whether tapping backdrop closes modal (default: true) */
  dismissOnBackdropPress?: boolean;
}

// Contemplative spring config - matches Button.tsx and GlassCard.tsx
const springConfig: WithSpringConfig = {
  damping: 20,
  mass: 0.5,
  stiffness: 120,
  overshootClamping: true,
  energyThreshold: 0.001,
};

const AnimatedPressable = Animated.createAnimatedComponent(Pressable);

export function AnimatedModal({
  visible,
  onRequestClose,
  children,
  contentStyle,
  dismissOnBackdropPress = true,
}: AnimatedModalProps) {
  const { theme } = useTheme();
  const scale = useSharedValue(0.5);
  const contentOpacity = useSharedValue(0);
  const backdropOpacity = useSharedValue(0);

  useEffect(() => {
    if (visible) {
      // Animate in
      scale.value = withSpring(1, springConfig);
      contentOpacity.value = withTiming(1, { duration: 200 });
      backdropOpacity.value = withTiming(1, { duration: 200 });
    } else {
      // Animate out
      scale.value = withSpring(0.5, springConfig);
      contentOpacity.value = withTiming(0, { duration: 150 });
      backdropOpacity.value = withTiming(0, { duration: 150 });
    }
  }, [visible, scale, contentOpacity, backdropOpacity]);

  const contentAnimatedStyle = useAnimatedStyle(() => ({
    transform: [{ scale: scale.value }],
    opacity: contentOpacity.value,
  }));

  const backdropAnimatedStyle = useAnimatedStyle(() => ({
    opacity: backdropOpacity.value,
  }));

  const handleBackdropPress = () => {
    if (dismissOnBackdropPress) {
      onRequestClose();
    }
  };

  return (
    <Modal
      visible={visible}
      transparent
      animationType="none" // We handle animation ourselves
      onRequestClose={onRequestClose}
    >
      {/* Animated backdrop */}
      <AnimatedPressable
        style={[styles.backdrop, backdropAnimatedStyle]}
        onPress={handleBackdropPress}
        accessibilityRole="button"
        accessibilityLabel="Close modal"
        accessibilityHint="Tap to close this dialog"
      />

      {/* Centered content container */}
      <View style={styles.centeredView} pointerEvents="box-none">
        <Animated.View
          style={[
            styles.modalContent,
            { backgroundColor: theme.backgroundDefault },
            Shadows.lifted,
            contentStyle,
            contentAnimatedStyle,
          ]}
        >
          {children}
        </Animated.View>
      </View>
    </Modal>
  );
}

const styles = StyleSheet.create({
  backdrop: {
    ...StyleSheet.absoluteFillObject,
    backgroundColor: "rgba(0, 0, 0, 0.5)",
  },
  centeredView: {
    flex: 1,
    justifyContent: "center",
    alignItems: "center",
    padding: Spacing.xl,
  },
  modalContent: {
    width: "100%",
    maxWidth: 400,
    borderRadius: BorderRadius.lg,
    padding: Spacing.xl,
  },
});
```
  </action>
  <verify>
- File exists at client/components/AnimatedModal.tsx
- Exports AnimatedModal function
- TypeScript compiles: `npx tsc --noEmit`
- Uses animationType="none" on native Modal
- Scale and opacity animated with spring/timing
  </verify>
  <done>AnimatedModal provides reusable scale+fade entrance animation with backdrop fade</done>
</task>

<task type="auto">
  <name>Task 2: Add backdrop fade animation refinements (UX-09)</name>
  <files>client/components/AnimatedModal.tsx</files>
  <action>
The backdrop fade is already implemented in Task 1. This task adds refinements:

1. Add accessibility attributes to backdrop for screen readers:
   ```typescript
   <AnimatedPressable
     style={[styles.backdrop, backdropAnimatedStyle]}
     onPress={handleBackdropPress}
     accessibilityRole="button"
     accessibilityLabel="Close modal"
     accessibilityHint="Tap outside content to dismiss"
   />
   ```

2. Ensure backdrop doesn't block content interaction:
   - The pointerEvents="box-none" on centeredView allows content touches
   - Backdrop has its own press handler

3. Support theme-aware backdrop color (optional enhancement):
   ```typescript
   const backdropColor = isDark
     ? "rgba(0, 0, 0, 0.6)"  // Darker for dark theme
     : "rgba(0, 0, 0, 0.5)"; // Standard for light theme
   ```

4. Add slight blur effect consideration for future (comment only):
   ```typescript
   // Future enhancement: Could use BlurView for backdrop
   // Similar to GlassCard's blur approach
   ```

The core backdrop fade (withTiming opacity 0->1 on show, 1->0 on hide) is already in place from Task 1.
  </action>
  <verify>
- Backdrop fades in over 200ms on modal show
- Backdrop fades out over 150ms on modal hide
- Accessibility attributes present on backdrop Pressable
- Theme-aware backdrop color applied
  </verify>
  <done>Backdrop fade animation refined with accessibility and theme-awareness</done>
</task>

<task type="auto">
  <name>Task 3: Update ExitConfirmationModal to use AnimatedModal (UX-10)</name>
  <files>client/components/ExitConfirmationModal.tsx, client/components/__tests__/AnimatedModal.test.tsx</files>
  <action>
Update ExitConfirmationModal to use AnimatedModal:

1. Replace the existing Modal implementation in ExitConfirmationModal.tsx:

```typescript
import React from "react";
import { View, StyleSheet } from "react-native";
import { ThemedText } from "./ThemedText";
import { Button } from "./Button";
import { AnimatedModal } from "./AnimatedModal";
import { useTheme } from "@/hooks/useTheme";
import { Spacing } from "@/constants/theme";

interface ExitConfirmationModalProps {
  visible: boolean;
  onConfirm: () => void;
  onCancel: () => void;
}

export function ExitConfirmationModal({
  visible,
  onConfirm,
  onCancel,
}: ExitConfirmationModalProps) {
  const { theme } = useTheme();

  return (
    <AnimatedModal
      visible={visible}
      onRequestClose={onCancel}
      dismissOnBackdropPress={true}
    >
      <ThemedText type="h4" style={styles.title}>
        Exit reflection?
      </ThemedText>
      <ThemedText
        type="body"
        style={[styles.message, { color: theme.textSecondary }]}
      >
        Your progress will be lost and cannot be recovered.
      </ThemedText>

      <View style={styles.buttonContainer}>
        <Button
          onPress={onCancel}
          variant="secondary"
          style={{ flex: 1, marginRight: Spacing.sm }}
        >
          Stay
        </Button>
        <Button
          onPress={onConfirm}
          variant="primary"
          style={{ flex: 1, backgroundColor: "#ef4444" }}
        >
          Exit
        </Button>
      </View>
    </AnimatedModal>
  );
}

const styles = StyleSheet.create({
  title: {
    marginBottom: Spacing.sm,
  },
  message: {
    marginBottom: Spacing.xl,
  },
  buttonContainer: {
    flexDirection: "row",
    justifyContent: "space-between",
  },
});
```

2. Key changes from original:
   - Remove direct Modal import
   - Remove Pressable overlay wrapper (AnimatedModal handles it)
   - Remove manual styling for overlay and modalContainer
   - AnimatedModal handles background color, shadows, border radius
   - Keep content (title, message, buttons) unchanged

3. Create tests for AnimatedModal in __tests__/AnimatedModal.test.tsx:

```typescript
import React from 'react';
import { render, fireEvent } from '@testing-library/react-native';
import { Text, View } from 'react-native';
import { AnimatedModal } from '../AnimatedModal';

// Mock reanimated
jest.mock('react-native-reanimated', () => require('react-native-reanimated/mock'));

describe('AnimatedModal', () => {
  it('renders children when visible', () => {
    const { getByText } = render(
      <AnimatedModal visible={true} onRequestClose={() => {}}>
        <Text>Modal Content</Text>
      </AnimatedModal>
    );
    expect(getByText('Modal Content')).toBeTruthy();
  });

  it('calls onRequestClose when backdrop is pressed', () => {
    const onRequestClose = jest.fn();
    const { getByLabelText } = render(
      <AnimatedModal visible={true} onRequestClose={onRequestClose}>
        <Text>Content</Text>
      </AnimatedModal>
    );
    fireEvent.press(getByLabelText('Close modal'));
    expect(onRequestClose).toHaveBeenCalled();
  });

  it('does not close on backdrop press when dismissOnBackdropPress is false', () => {
    const onRequestClose = jest.fn();
    const { getByLabelText } = render(
      <AnimatedModal
        visible={true}
        onRequestClose={onRequestClose}
        dismissOnBackdropPress={false}
      >
        <Text>Content</Text>
      </AnimatedModal>
    );
    fireEvent.press(getByLabelText('Close modal'));
    expect(onRequestClose).not.toHaveBeenCalled();
  });

  it('applies custom contentStyle', () => {
    const { getByTestId } = render(
      <AnimatedModal
        visible={true}
        onRequestClose={() => {}}
        contentStyle={{ padding: 100 }}
      >
        <View testID="content">
          <Text>Content</Text>
        </View>
      </AnimatedModal>
    );
    // Test that component renders without error with custom style
    expect(getByTestId('content')).toBeTruthy();
  });
});
```
  </action>
  <verify>
- ExitConfirmationModal imports and uses AnimatedModal
- Original functionality preserved (confirm/cancel buttons work)
- AnimatedModal tests pass: `npm run test:mobile -- AnimatedModal`
- TypeScript compiles: `npx tsc --noEmit`
- Visual: modal scales in smoothly (not abrupt fade)
  </verify>
  <done>ExitConfirmationModal uses AnimatedModal; modal animations consistent with card animations</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. AnimatedModal.tsx exists and exports AnimatedModal
3. ExitConfirmationModal uses AnimatedModal (no direct Modal import)
4. AnimatedModal tests pass: `npm run test:mobile -- AnimatedModal`
5. Modal scales from 0.5 to 1 with spring physics on open
6. Backdrop fades 0 to 1 with timing animation
7. springConfig matches Button.tsx (damping:20, mass:0.5, stiffness:120)
</verification>

<success_criteria>
1. AnimatedModal component created with scale+fade entrance
2. Backdrop fade uses withTiming (200ms in, 150ms out)
3. Content scale uses withSpring with contemplative config
4. ExitConfirmationModal refactored to use AnimatedModal
5. Backdrop press dismisses modal (configurable)
6. Accessibility attributes on backdrop
7. Unit tests verify render, dismiss, and backdrop behavior
8. Zero TypeScript errors
9. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-ui-ux-polish-animation-enhancements/09-04-SUMMARY.md`
</output>
