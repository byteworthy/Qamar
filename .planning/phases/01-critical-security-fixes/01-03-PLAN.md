---
phase: 01-critical-security-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - server/index.ts
autonomous: true

must_haves:
  truths:
    - "Stripe webhook URL uses explicit domain configuration"
    - "Webhook setup does not rely on brittle string splitting"
    - "Missing domain configuration is handled gracefully with clear error"
  artifacts:
    - path: "server/index.ts"
      provides: "Robust Stripe webhook domain handling"
      contains: "STRIPE_WEBHOOK_DOMAIN"
  key_links:
    - from: "server/index.ts"
      to: "initStripe"
      via: "webhook URL construction"
      pattern: "process\\.env\\.STRIPE_WEBHOOK_DOMAIN"
---

<objective>
Fix Stripe webhook domain handling to use explicit configuration instead of brittle first-domain parsing.

Purpose: Eliminate silent webhook failures when REPLIT_DOMAINS format changes or contains unexpected values.

Output: Webhook URL constructed from explicit STRIPE_WEBHOOK_DOMAIN environment variable with proper fallback and error handling.
</objective>

<execution_context>
@C:\Users\richa\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\richa\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@server/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add STRIPE_WEBHOOK_DOMAIN configuration</name>
  <files>server/index.ts</files>
  <action>
In `server/index.ts`, modify the `initStripe` function (around lines 286-331) to use explicit domain configuration:

FIND this code (around line 301):
```typescript
log("Setting up managed webhook...");
const webhookBaseUrl = `https://${process.env.REPLIT_DOMAINS?.split(",")[0]}`;
```

REPLACE WITH:
```typescript
log("Setting up managed webhook...");

// Use explicit webhook domain if configured, otherwise fall back to first Replit domain
const webhookDomain = process.env.STRIPE_WEBHOOK_DOMAIN
  || process.env.REPLIT_DOMAINS?.split(",")[0]?.trim();

if (!webhookDomain) {
  log("WARNING: No webhook domain configured. Set STRIPE_WEBHOOK_DOMAIN or REPLIT_DOMAINS.");
  log("Skipping Stripe webhook setup - billing webhooks will not work.");
  return;
}

const webhookBaseUrl = `https://${webhookDomain}`;
log(`Using webhook base URL: ${webhookBaseUrl}`);
```

This change:
1. Prefers explicit STRIPE_WEBHOOK_DOMAIN env var (most reliable)
2. Falls back to REPLIT_DOMAINS parsing (existing behavior)
3. Trims whitespace from parsed domain
4. Logs clear warning if no domain is configured
5. Skips webhook setup instead of passing undefined URL
  </action>
  <verify>
- TypeScript compilation passes: `npx tsc --noEmit`
- Code checks for STRIPE_WEBHOOK_DOMAIN first
- Clear logging indicates which domain is being used
  </verify>
  <done>Webhook domain handling uses explicit configuration with fallback</done>
</task>

<task type="auto">
  <name>Task 2: Document the new environment variable</name>
  <files>server/index.ts</files>
  <action>
Add a comment in `server/index.ts` near the top of the file (after imports, before app creation) documenting the new environment variable:

```typescript
/**
 * Environment Variables:
 * - STRIPE_WEBHOOK_DOMAIN: Explicit domain for Stripe webhooks (preferred)
 *   Example: "myapp.example.com"
 *   Falls back to first domain in REPLIT_DOMAINS if not set.
 */
```

This helps future developers understand the configuration option.
  </action>
  <verify>
- Comment is present explaining STRIPE_WEBHOOK_DOMAIN
  </verify>
  <done>Environment variable documented in code comments</done>
</task>

<task type="auto">
  <name>Task 3: Verify changes and run tests</name>
  <files>server/index.ts</files>
  <action>
1. Run TypeScript type check:
   ```bash
   npx tsc --noEmit
   ```

2. Run tests to ensure nothing is broken:
   ```bash
   npm test
   ```

3. Verify the server starts without errors (webhook setup may warn if domains not configured in test env):
   ```bash
   # Quick smoke test - server should start
   timeout 10 npm run dev || true
   ```

The server should start successfully. If STRIPE_WEBHOOK_DOMAIN and REPLIT_DOMAINS are both unset, it will log a warning and skip webhook setup (which is the correct behavior).
  </action>
  <verify>
- `npx tsc --noEmit` exits with code 0
- `npm test` passes
- Server starts without throwing errors
  </verify>
  <done>Stripe webhook domain handling verified working</done>
</task>

</tasks>

<verification>
1. Read `server/index.ts` and confirm:
   - STRIPE_WEBHOOK_DOMAIN is checked first
   - Fallback to REPLIT_DOMAINS with trim()
   - Clear warning logged if neither is set
   - Webhook setup skipped (not crashed) if no domain
2. Run `npx tsc --noEmit` to verify TypeScript compilation
3. Run `npm test` to ensure existing tests still pass
</verification>

<success_criteria>
1. `initStripe` checks `STRIPE_WEBHOOK_DOMAIN` environment variable first
2. Falls back to `REPLIT_DOMAINS?.split(",")[0]?.trim()` if STRIPE_WEBHOOK_DOMAIN not set
3. Logs clear warning if no domain is configured
4. Skips webhook setup gracefully instead of passing undefined/malformed URL
5. TypeScript compilation passes
6. Tests pass
7. Code committed with clear commit message referencing INFRA-01
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-security-fixes/01-03-SUMMARY.md`
</output>
