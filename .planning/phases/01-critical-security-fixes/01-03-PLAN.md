---
phase: 01-critical-security-fixes
plan: 03
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - server/index.ts
  - .env.example
  - server/.env.example
autonomous: true

must_haves:
  truths:
    - "Stripe webhook URL uses explicit domain configuration"
    - "Webhook setup does not rely on brittle string splitting"
    - "Missing domain configuration triggers graceful degradation (webhook setup skipped with warning, not crash)"
    - "STRIPE_WEBHOOK_DOMAIN documented in .env.example files"
  artifacts:
    - path: "server/index.ts"
      provides: "Robust Stripe webhook domain handling"
      contains: "STRIPE_WEBHOOK_DOMAIN"
  key_links:
    - from: "server/index.ts"
      to: "initStripe"
      via: "webhook URL construction"
      pattern: "process\\.env\\.STRIPE_WEBHOOK_DOMAIN"
---

<objective>
Fix Stripe webhook domain handling to use explicit configuration instead of brittle first-domain parsing.

Purpose: Eliminate silent webhook failures when REPLIT_DOMAINS format changes or contains unexpected values.

Output: Webhook URL constructed from explicit STRIPE_WEBHOOK_DOMAIN environment variable with proper fallback and error handling.
</objective>

<execution_context>
@C:\Users\richa\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\richa\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@server/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add STRIPE_WEBHOOK_DOMAIN configuration</name>
  <files>server/index.ts</files>
  <action>
In `server/index.ts`, modify the `initStripe` function (around lines 286-331) to use explicit domain configuration:

FIND this code (around line 301):
```typescript
log("Setting up managed webhook...");
const webhookBaseUrl = `https://${process.env.REPLIT_DOMAINS?.split(",")[0]}`;
```

REPLACE WITH:
```typescript
log("Setting up managed webhook...");

// Use explicit webhook domain if configured, otherwise fall back to first Replit domain
const webhookDomain = process.env.STRIPE_WEBHOOK_DOMAIN
  || process.env.REPLIT_DOMAINS?.split(",")[0]?.trim();

if (!webhookDomain) {
  log("WARNING: No webhook domain configured. Set STRIPE_WEBHOOK_DOMAIN or REPLIT_DOMAINS.");
  log("Skipping Stripe webhook setup - billing webhooks will not work.");
  return;
}

const webhookBaseUrl = `https://${webhookDomain}`;
log(`Using webhook base URL: ${webhookBaseUrl}`);
```

This change:
1. Prefers explicit STRIPE_WEBHOOK_DOMAIN env var (most reliable)
2. Falls back to REPLIT_DOMAINS parsing (existing behavior)
3. Trims whitespace from parsed domain
4. Logs clear warning if no domain is configured
5. Skips webhook setup instead of passing undefined URL
  </action>
  <verify>
- TypeScript compilation passes: `npx tsc --noEmit`
- Code checks for STRIPE_WEBHOOK_DOMAIN first
- Clear logging indicates which domain is being used
  </verify>
  <done>Webhook domain handling uses explicit configuration with fallback</done>
</task>

<task type="auto">
  <name>Task 2: Document the new environment variable</name>
  <files>server/index.ts, .env.example, server/.env.example</files>
  <action>
1. Add a comment in `server/index.ts` near the top of the file (after imports, before app creation) documenting the new environment variable:

```typescript
/**
 * Environment Variables:
 * - STRIPE_WEBHOOK_DOMAIN: Explicit domain for Stripe webhooks (preferred)
 *   Example: "myapp.example.com"
 *   Falls back to first domain in REPLIT_DOMAINS if not set.
 */
```

2. Check if `.env.example` exists in the project root. If it does, add the new environment variable to the BILLING section:

```bash
# Explicit domain for Stripe webhooks (recommended for production)
# Falls back to first domain in REPLIT_DOMAINS if not set
# STRIPE_WEBHOOK_DOMAIN=your-production-domain.com
```

If `.env.example` does not exist at the root, skip this step.

3. Check if `server/.env.example` exists. If it does, add the new environment variable to the BILLING section:

```bash
# Explicit domain for Stripe webhooks (recommended for production)
# Falls back to first domain in REPLIT_DOMAINS if not set
# STRIPE_WEBHOOK_DOMAIN=your-production-domain.com
```

If `server/.env.example` does not exist, skip this step.

4. Search for any README or deployment documentation files that might list environment variables:

```bash
# Search for files that might document environment variables
grep -ril "STRIPE_SECRET_KEY\|REPLIT_DOMAINS" README*.md docs/*.md 2>/dev/null || echo "No README/docs files found with env vars"
```

If any such files are found, add STRIPE_WEBHOOK_DOMAIN documentation to them as well.

This ensures the environment variable is documented in code and all existing configuration documentation.
  </action>
  <verify>
- Comment is present in server/index.ts explaining STRIPE_WEBHOOK_DOMAIN
- If .env.example exists, STRIPE_WEBHOOK_DOMAIN is documented there
- If server/.env.example exists, STRIPE_WEBHOOK_DOMAIN is documented there
- Any README/docs files mentioning Stripe env vars now include STRIPE_WEBHOOK_DOMAIN
  </verify>
  <done>Environment variable documented in code and all relevant configuration files</done>
</task>

<task type="auto">
  <name>Task 3: Verify changes and run tests</name>
  <files>server/index.ts</files>
  <action>
1. Run TypeScript type check:
   ```bash
   npx tsc --noEmit
   ```

2. Run tests to ensure nothing is broken:
   ```bash
   npm test
   ```

3. Verify the server starts without errors (webhook setup may warn if domains not configured in test env):
   ```bash
   # Quick smoke test - server should start
   timeout 10 npm run dev || true
   ```

The server should start successfully. If STRIPE_WEBHOOK_DOMAIN and REPLIT_DOMAINS are both unset, it will log a warning and skip webhook setup (which is the correct behavior).
  </action>
  <verify>
- `npx tsc --noEmit` exits with code 0
- `npm test` passes
- Server starts without throwing errors
  </verify>
  <done>Stripe webhook domain handling verified working</done>
</task>

</tasks>

<verification>
1. Read `server/index.ts` and confirm:
   - STRIPE_WEBHOOK_DOMAIN is checked first
   - Fallback to REPLIT_DOMAINS with trim()
   - Clear warning logged if neither is set
   - Webhook setup skipped (not crashed) if no domain
2. Run `npx tsc --noEmit` to verify TypeScript compilation
3. Run `npm test` to ensure existing tests still pass
</verification>

<success_criteria>
1. `initStripe` checks `STRIPE_WEBHOOK_DOMAIN` environment variable first
2. Falls back to `REPLIT_DOMAINS?.split(",")[0]?.trim()` if STRIPE_WEBHOOK_DOMAIN not set
3. Logs clear warning if no domain is configured
4. Graceful degradation when STRIPE_WEBHOOK_DOMAIN is not configured: Server continues to start normally, webhook setup is skipped with warning, billing webhooks disabled but core app functionality maintained
5. STRIPE_WEBHOOK_DOMAIN documented in all relevant .env.example files and configuration docs
6. TypeScript compilation passes
7. Tests pass
8. Code committed with clear commit message referencing INFRA-01
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-security-fixes/01-03-SUMMARY.md`
</output>
