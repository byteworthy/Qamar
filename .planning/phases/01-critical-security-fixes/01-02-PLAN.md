---
phase: 01-critical-security-fixes
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - server/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "CORS is handled by established cors npm package"
    - "Custom CORS middleware function is removed"
    - "CORS configuration supports Replit domains correctly"
    - "OPTIONS preflight requests handled correctly (Access-Control-Allow-Origin and Access-Control-Allow-Methods headers present)"
  artifacts:
    - path: "server/index.ts"
      provides: "CORS middleware using cors package"
      contains: "import cors from"
    - path: "package.json"
      provides: "cors dependency"
      contains: "\"cors\":"
  key_links:
    - from: "server/index.ts"
      to: "cors"
      via: "npm package import"
      pattern: "app\\.use\\(cors\\("
---

<objective>
Replace custom CORS middleware with the established `cors` npm package.

Purpose: Eliminate potential misconfiguration risks from hand-rolled CORS logic by using battle-tested library.

Output: CORS handling using `cors` package with equivalent functionality to current implementation.
</objective>

<execution_context>
@C:\Users\richa\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\richa\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@server/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install cors package and types</name>
  <files>package.json</files>
  <action>
Install the `cors` package and its TypeScript types:

```bash
npm install cors
npm install -D @types/cors
```

This adds the established CORS middleware package that handles all edge cases correctly.
  </action>
  <verify>
- Check cors installation: `npm ls cors || echo "cors package not found"`
- Check @types/cors installation: `npm ls @types/cors || echo "@types/cors package not found"`
- Verify package.json: `grep '"cors":' package.json` shows cors entry
  </verify>
  <done>cors package and types installed</done>
</task>

<task type="auto">
  <name>Task 2: Replace custom CORS with cors package</name>
  <files>server/index.ts</files>
  <action>
In `server/index.ts`:

1. Add import at top of file (after other imports):
```typescript
import cors from "cors";
```

2. Replace the entire `setupCors` function (lines 62-94) with a new implementation:

```typescript
function setupCors(app: express.Application): void {
  // Build allowed origins from Replit environment variables
  const allowedOrigins: string[] = [];

  if (process.env.REPLIT_DEV_DOMAIN) {
    allowedOrigins.push(`https://${process.env.REPLIT_DEV_DOMAIN}`);
  }

  if (process.env.REPLIT_DOMAINS) {
    process.env.REPLIT_DOMAINS.split(",").forEach((d: string) => {
      const domain = d.trim();
      if (domain) {
        allowedOrigins.push(`https://${domain}`);
      }
    });
  }

  app.use(
    cors({
      origin: (origin, callback) => {
        // Allow requests with no origin (mobile apps, curl, etc.)
        if (!origin) {
          return callback(null, true);
        }
        if (allowedOrigins.includes(origin)) {
          return callback(null, true);
        }
        return callback(new Error("Not allowed by CORS"));
      },
      methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
      allowedHeaders: ["Content-Type"],
      credentials: true,
    })
  );
}
```

This maintains the same behavior:
- Only allows origins from REPLIT_DEV_DOMAIN and REPLIT_DOMAINS
- Supports credentials (cookies)
- Allows standard HTTP methods
- Handles OPTIONS preflight automatically via cors package
  </action>
  <verify>
- TypeScript compilation passes: `npx tsc --noEmit`
- `cors` import is present at top of file
- Old manual CORS logic is removed
  </verify>
  <done>Custom CORS replaced with cors package configuration</done>
</task>

<task type="auto">
  <name>Task 3: Verify CORS configuration works</name>
  <files>server/index.ts</files>
  <action>
1. Run TypeScript type check:
   ```bash
   npx tsc --noEmit
   ```

2. Run tests to ensure nothing is broken:
   ```bash
   npm test
   ```

3. Verify OPTIONS preflight requests are handled correctly (MANDATORY):
   ```bash
   # Start server in background
   npm run dev &
   SERVER_PID=$!
   sleep 5

   # Test OPTIONS preflight request
   CORS_RESPONSE=$(curl -s -I -X OPTIONS http://localhost:5000/api/health \
     -H "Origin: https://test.replit.dev" \
     -H "Access-Control-Request-Method: POST" 2>/dev/null)

   # Verify CORS headers present (both required)
   if echo "$CORS_RESPONSE" | grep -iq "access-control-allow-origin"; then
     echo "✓ Access-Control-Allow-Origin header present"
   else
     echo "✗ FAILED: Access-Control-Allow-Origin header missing"
   fi

   if echo "$CORS_RESPONSE" | grep -iq "access-control-allow-methods"; then
     echo "✓ Access-Control-Allow-Methods header present"
   else
     echo "✗ FAILED: Access-Control-Allow-Methods header missing"
   fi

   # Cleanup
   kill $SERVER_PID 2>/dev/null || true
   ```

The response MUST include both Access-Control-Allow-Origin and Access-Control-Allow-Methods headers for OPTIONS requests. Both checks are required for success.
  </action>
  <verify>
- `npx tsc --noEmit` exits with code 0
- `npm test` passes
- Server starts without errors
- OPTIONS request returns Access-Control-Allow-Origin header
- OPTIONS request returns Access-Control-Allow-Methods header
  </verify>
  <done>CORS configuration verified working with proper preflight handling</done>
</task>

</tasks>

<verification>
1. `npm ls cors` confirms package installed
2. `server/index.ts` imports `cors` from package
3. `server/index.ts` uses `app.use(cors({...}))` pattern
4. No manual CORS header setting (no `res.header("Access-Control-...`)
5. TypeScript compiles without errors
6. Tests pass
</verification>

<success_criteria>
1. `cors` package installed as dependency
2. `@types/cors` installed as dev dependency
3. Custom CORS function uses `cors()` middleware
4. Equivalent functionality maintained (Replit domains, credentials, methods)
5. TypeScript compilation passes
6. Tests pass
7. Code committed with clear commit message referencing SEC-02
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-security-fixes/01-02-SUMMARY.md`
</output>
