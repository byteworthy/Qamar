---
phase: 01-critical-security-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/encryption.ts
autonomous: true

must_haves:
  truths:
    - "Encryption failures throw errors instead of returning plaintext"
    - "Decryption failures throw errors instead of returning encrypted text"
    - "HIPAA compliance maintained by never exposing plaintext on failure"
  artifacts:
    - path: "server/encryption.ts"
      provides: "Fail-closed encryption/decryption functions"
      contains: "throw new Error"
  key_links:
    - from: "server/encryption.ts"
      to: "catch block"
      via: "error throw instead of return"
      pattern: "throw new Error.*encryption failed"
---

<objective>
Fix encryption fallback behavior to throw errors instead of silently returning plaintext or encrypted text.

Purpose: Eliminate critical HIPAA violation risk where encryption/decryption failures could expose sensitive user data in plaintext.

Output: Modified encryption.ts that fails closed on any encryption or decryption error.
</objective>

<execution_context>
@C:\Users\richa\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\richa\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@server/encryption.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix encryptData fallback behavior</name>
  <files>server/encryption.ts</files>
  <action>
In `server/encryption.ts`, modify the `encryptData` function catch block (around lines 67-70):

CURRENT CODE (DANGEROUS):
```typescript
} catch (error) {
  console.error("[Encryption] Encryption failed:", error);
  return text; // Fallback to plaintext in dev
}
```

CHANGE TO:
```typescript
} catch (error) {
  console.error("[Encryption] Encryption failed:", error);
  throw new Error(`Encryption failed: ${error instanceof Error ? error.message : String(error)}`);
}
```

This ensures encryption failures are never silent and always propagate up the call stack. Remove the comment "Fallback to plaintext in dev" as this behavior is being eliminated.
  </action>
  <verify>
- TypeScript compilation passes: `npx tsc --noEmit`
- Function now throws on error instead of returning plaintext
  </verify>
  <done>encryptData throws Error on any encryption failure</done>
</task>

<task type="auto">
  <name>Task 2: Fix decryptData fallback behavior</name>
  <files>server/encryption.ts</files>
  <action>
In `server/encryption.ts`, modify the `decryptData` function catch block (around lines 105-108):

CURRENT CODE (DANGEROUS):
```typescript
} catch (error) {
  console.error("[Encryption] Decryption failed:", error);
  return encryptedText; // Fallback
}
```

CHANGE TO:
```typescript
} catch (error) {
  console.error("[Encryption] Decryption failed:", error);
  throw new Error(`Decryption failed: ${error instanceof Error ? error.message : String(error)}`);
}
```

This ensures decryption failures propagate up and are handled explicitly by calling code. The calling code should have appropriate error handling for production scenarios.
  </action>
  <verify>
- TypeScript compilation passes: `npx tsc --noEmit`
- Function now throws on error instead of returning encrypted text
  </verify>
  <done>decryptData throws Error on any decryption failure</done>
</task>

<task type="auto">
  <name>Task 3: Verify changes and run tests</name>
  <files>server/encryption.ts</files>
  <action>
1. Run TypeScript type check to ensure no type errors:
   ```bash
   npx tsc --noEmit
   ```

2. Run existing tests to ensure nothing is broken:
   ```bash
   npm test
   ```

3. Verify the encryption module still works by checking the file compiles without errors.

If tests fail due to the new throw behavior, that indicates calling code needs to be updated to handle errors properly - which is the correct behavior.
  </action>
  <verify>
- `npx tsc --noEmit` exits with code 0
- `npm test` passes (or failures are documented as expected due to new error handling)
  </verify>
  <done>Encryption module compiles and tests pass (or failures documented)</done>
</task>

</tasks>

<verification>
1. Read `server/encryption.ts` and confirm both catch blocks now throw errors
2. Run `npx tsc --noEmit` to verify TypeScript compilation
3. Run `npm test` to ensure existing tests still pass
4. Confirm no `return text` or `return encryptedText` in catch blocks
</verification>

<success_criteria>
1. `encryptData` throws `Error` on encryption failure (never returns plaintext)
2. `decryptData` throws `Error` on decryption failure (never returns encrypted text)
3. TypeScript compilation passes
4. Tests pass (or failures are documented if they rely on old fallback behavior)
5. Code committed with clear commit message referencing SEC-01
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-security-fixes/01-01-SUMMARY.md`
</output>
